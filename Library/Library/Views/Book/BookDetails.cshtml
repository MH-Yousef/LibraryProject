@using Data.DTOs.Book

@{
    ViewData["Title"] = "BookDetails";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var Reviews = ViewBag.Reviews;
    var ShareTypes = ViewBag.ShareTypes;
    var user = ViewBag.User;
}
@model BookDTO
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-6">
                        <img src="~/Images/Book/@Model.Image" alt="" class=" mx-auto  d-block" height="400">
                        <div class="row">
                            <div class="col-sm-4">
                            </div>
                            <div class="col-sm-4"></div>
                            <div class="col-sm-4"></div>
                        </div>
                    </div><!--end col-->
                    <div class="col-lg-6 align-self-center">
                        <div class="single-pro-detail">
                            <p class="mb-1">Library Project</p>
                            <div class="custom-border"></div>
                            <h3 class="pro-title">@Model.Title</h3>
                            <p class="text-muted mb-2">@Model.Description</p>

                            <h6 class="text-muted font-13">Features :</h6>
                            <ul class="list-unstyled pro-features border-0">
                                <li>Section: @ViewBag.CurrentSection</li>
                                <li>Category: @ViewBag.CurrentCategory</li>
                                <li>Shelf : @ViewBag.CurrentShelf </li>
                            </ul>


                        </div>
                    </div><!--end col-->
                </div><!--end row-->
            </div><!--end card-body-->
        </div><!--end card-->
        <div class="card">
            <div class="card-body">
                <div class="single-pro-info-tab">
                    <ul class="nav nav-pills mb-0 nav-justified" id="pills-tab" role="tablist">

                        <li class="nav-item">
                            <a class="nav-link active" id="pills-reviews-tab" data-toggle="pill" href="#pills-reviews" aria-selected="false">Reviews</a>
                        </li>

                    </ul>
                </div>
                <div>
                    <div class="tab-content mt-4" id="pills-tabContent">

                        <div class="tab-pane fade mt-4 active show" id="pills-reviews">
                            <div>
                                @if (Reviews.Count > 0)
                                {
                                    foreach (var item in Reviews)
                                    {
                                        <div class="row">
                                            <div class="col-md-12">
                                                <div class="reviewer ">
                                                    <a href="" class="text-muted float-right"><i class="mdi mdi-reply mr-1"></i>@item.UpdatedAt</a>
                                                    <p class="font-weight-bold font-15 mb-1">@item.Content</p>
                                                    <p class="text-muted font-13">by - @item.UserId</p>

                                                </div>
                                            </div>
                                        </div>
                                    }
                                }

                                <form id="ReviewForm">
                                    <div class="general-label">
                                        <div class="col-12">
                                            <div class="row">
                                                <div class="col-10">
                                                    <div class="mt-3">
                                                        <textarea id="Content" name="Content" class="form-control" maxlength="225" rows="3" placeholder="Add your review" style="height: 107px;"></textarea>
                                                        <div class="errorTxt text-danger"></div>
                                                    </div>

                                                </div>
                                                <div class="col-2">
                                                    <div class="row">
                                                        <div class="mt-3" style="width: 100%;">
                                                            <select id="ShareType" name="ShareType" class="select2 form-control mb-3 custom-select" style="width: 100%; height:36px;">
                                                                <option value="" selected disabled>Share Type</option>
                                                                @foreach (var item in ShareTypes)
                                                                {
                                                                    <option value="@((int)item)">@item</option>
                                                                }
                                                            </select>
                                                            <div class="errorTxt text-danger"></div>
                                                        </div>


                                                    </div>
                                                    <div class="row">
                                                        <div class="mt-3" style="width: 100%;">
                                                            <button id="submitBtn" type="submit" class="btn btn-primary" style="width: 100%;">Submit</button>
                                                            
                                                        </div>
                                                    </div>


                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div><!--end col-->
</div>

<script>
    $('#testBtn').click(function () {
        var content = $("#Content").val();
        var shareType = $("#ShareType option:selected").val();
        var bookId = @Model.Id;
        var userId = @user.Id;

        console.log(content);
        console.log(shareType);
        console.log(bookId);
        console.log(userId);
    });

    $(document).ready(function () {
        $('#ReviewForm').validate({
            rules: {
                Content: {
                    required: true,
                    minlength: 10
                },
                ShareType: {
                    required: true
                }
            },
            messages: {
                Content: {
                    required: "Content is required",
                    minlength: "Content must be at least 10 characters"
                },
                ShareType: {
                    required: "Share Type is required"
                }
            },
            errorElement: 'div',
            errorPlacement: function (error, element) {
                if (element.hasClass('select2-hidden-accessible')) {
                    error.insertAfter(element.next('.select2'));
                } else {
                    error.insertAfter(element.next('.errorTxt'));
                }
            },
            submitHandler: function (form) {
                submitForm();
            }
        });

        $("#submitBtn").click(function (event) {
            event.preventDefault();

            function submitForm() {

                var content = $("#Content").val();
                var shareType = parseInt($("#ShareType option:selected").val());
                var bookId = @Model.Id;
                var userId = @user.Id;
                $.ajax({
                    url: "/Review/AddReview",
                    type: "POST",
                    data: { Content: content, type: shareType, BookId: bookId, UserId: userId },
                    success: function (data) {
                        if (data) {
                            alert("Review added successfully");
                            location.reload();
                        }
                        else {
                            alert("Error");
                        }
                    },
                    error: function () {
                        alert("Error");
                    }
                });

            }
            if ($("#ReviewForm").valid()) {
                submitForm();
            }
        });




    });
</script>